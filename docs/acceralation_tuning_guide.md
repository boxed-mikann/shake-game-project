# 加速度センサー チューニングガイド(AI生成：未チェック)

フリフリ検知精度を最適化するための診断ツールの使用方法です。

## 概要

2つの診断方式があります：

| 方式 | 用途 | 環境 | ファイル |
|------|------|------|---------|
| **オフライン版** | センサー初期調整 | 子機単体 | `child_device_diagnostic.ino` |
| **オンライン版** | ゲーム実環境での検証 | 親機+子機 | `child_device_online_diagnostic.ino` |

## オフライン版（子機単体診断）

### 原理

子機を直接PCに接続し、MPU-6050からリアルタイムで加速度データを取得します。

```
子機(ESP32)
  ↓ (USB Serial)
PC (Processing 画面表示)
```

### セットアップ

#### 1. ファームウェア書き込み

```bash
# Arduino IDE で以下を開く
firmware/child_device_diagnostic/child_device_diagnostic.ino
```

**重要:** このバージョンは **ESP-NOW通信なし**（シンプル版）

#### 2. Processing起動

```bash
# Processingで以下を開く
software/processing/acceleration_plotter/acceleration_plotter.pde
```

### 操作方法

#### キーボード操作

| キー | 機能 | 説明 |
|------|------|------|
| **SPACE** | 一時停止/再開 | グラフの更新を停止して詳細確認 |
| **+** | しきい値 UP | 加速度のしきい値を +500 増加 |
| **-** | しきい値 DOWN | 加速度のしきい値を -500 減少 |
| **e** | CSV出力 | 現在のデータを CSV ファイルで保存 |
| **c** | クリア | グラフをリセット |
| **r** | 再接続 | ポート再接続 |

### グラフの見方

#### 上のグラフ（X, Y, Z 各軸）

```
    赤: X軸（前後方向）
    緑: Y軸（左右方向）
    青: Z軸（上下方向）
```

**解釈:**
- 安定時: 各軸がほぼ0付近 ± 500
- フリフリ時: 各軸が ± 15000 程度に変動

#### 下のグラフ（合成加速度）

```
    オレンジ: √(X² + Y² + Z²)
    赤い横線: しきい値ライン
```

**解釈:**
- しきい値ラインを超える動き = フリフリと判定

### 調整の流れ

#### ステップ1: 静止状態を確認

1. 子機を動かさずに10秒待つ
2. グラフが安定しているか確認
3. ノイズが多い場合はセンサーのはんだを確認

#### ステップ2: フリフリ動作を確認

1. 子機を上下方向に数回フリフリ
2. グラフがしきい値を超えるか確認
3. グラフから超える時間幅を計測

#### ステップ3: しきい値を調整

1. SPACE で一時停止
2. フリフリの最大値を確認
3. +/- キーで適切なしきい値を探す
4. 複数回テストして最適値を決定

#### ステップ4: データをエクスポート

1. 最適パラメータでデータ取得
2. e キーで CSV 出力
3. Excel/Google Sheets で詳細分析

### CSV ファイル形式

```csv
Time(ms),AcX,AcY,AcZ,TotalAccel
0,120,250,-980,1023.45
50,130,260,-970,1031.22
100,140,270,-960,1039.00
```

**列の説明:**
- `Time(ms)`: データ取得時からの経過時間
- `AcX, AcY, AcZ`: 各軸の加速度値
- `TotalAccel`: 合成加速度

### トラブルシューティング

#### Q: グラフが表示されない

**確認項目:**
1. Arduino IDE のシリアルモニタが閉じているか
2. ボーレート 115200 に設定されているか
3. USB ケーブルが接触不良でないか

#### Q: 静止時のノイズが大きい

**対策:**
1. センサーと ESP32 の接続を確認
2. はんだ接続にひび割れがないか確認
3. グラウンド線が確実に接続されているか確認

#### Q: フリフリを認識しない

**対策:**
1. しきい値が高すぎる
2. -キーで段階的に下げる
3. 典型値は 12000～20000

---

## オンライン版（実ゲーム環境診断）

### 原理

親機・子機の実運用構成で、親機経由でデータを PC に送信します。

```
子機(ESP32+MPU6050)
  ↓ (ESP-NOW 50ms間隔)
親機(ESP32)
  ↓ (USB Serial)
PC (Processing 画面表示)
```

### メリット

✅ **複数子機同時監視** - 0-9キーで子機を切り替え  
✅ **50ms連続データ** - フリフリの詳細な波形を確認  
✅ **ゲーム実環境テスト** - 実運用での動作確認  

### セットアップ

#### 1. ファームウェア書き込み

**親機:**
```bash
firmware/parent_device/parent_device.ino
```

**各子機:**
```bash
firmware/child_device_online_diagnostic/child_device_online_diagnostic.ino
```

編集が必要な部分：
```cpp
#define CHILD_ID 0  // 各子機で異なる ID (0-19)
uint8_t parentMAC[] = {0xXX, 0xXX, ...};  // 親機の MAC アドレス
```

#### 2. Processing起動

```bash
software/processing/acceleration_plotter_online/acceleration_plotter_online.pde
```

### 操作方法

#### キーボード操作

| キー | 機能 | 説明 |
|------|------|------|
| **0-9** | 子機選択 | 表示する子機を切り替え（0=子機#0, 1=子機#1, ...） |
| **SPACE** | 一時停止/再開 | グラフの更新を停止 |
| **+** | しきい値 UP | +500 |
| **-** | しきい値 DOWN | -500 |
| **e** | CSV出力 | ファイル名に子機ID含む |
| **c** | クリア | グラフをリセット |
| **r** | 再接続 | ポート再接続 |

### 使用シーン

#### シーン1: 複数子機のバラツキ確認

1. 全子機で同じ動きをさせる
2. 0-9キーで各子機を切り替え
3. グラフの形が同じか確認

**目的:** センサーのばらつきを検出

#### シーン2: ゲーム環境での検証

1. ゲームを実行しながら 0キー で子機#0 を監視
2. フリフリ時にグラフがしきい値を超えるか確認
3. 必要に応じてしきい値を調整

#### シーン3: マルチプレイ環境でのテスト

1. 複数の子機を複数プレイヤーで操作
2. 親機のデータ受信状況を確認
3. 遅延やデータロスがないか検証

### CSV ファイル形式

```csv
Time(ms),AcX,AcY,AcZ,TotalAccel,ShakeCount
0,120,250,-980,1023.45,0
50,130,260,-970,1031.22,0
100,5000,6000,-4000,9083.47,1
```

**追加列:**
- `ShakeCount`: フリフリ検知カウント

---

## 最適なしきい値の決定方法

### 推奨プロセス

#### ステップ1: オフライン版で基準値を探す

1. 最初は `SHAKE_THRESHOLD = 15000` でテスト
2. グラフでフリフリの最小・最大値を計測
3. 余裕を持たせた値に調整

**例:**
```
フリフリ最小値: 12000
フリフリ最大値: 25000
ノイズ最大値: 2000

推奨しきい値: 5000 ～ 10000
```

#### ステップ2: オンライン版で検証

1. 決定した値で複数子機をテスト
2. 誤検知がないか確認
3. 個体差による調整が必要か確認

#### ステップ3: CSV で統計分析（オプション）

Excel/Google Sheets でデータ分析：
```
= MAX(AcX:AcZ)  // 最大値
= MIN(AcX:AcZ)  // 最小値
= AVERAGE()     // 平均値
```

---

## よくある設定値

| 用途 | しきい値 | 備考 |
|------|---------|------|
| **敏感（小さな動き検知）** | 5000～8000 | 誤検知の可能性 |
| **標準（推奨）** | 10000～15000 | バランス型 |
| **鈍感（大きな動き必須）** | 20000～25000 | 検知漏れの可能性 |

---

## チェックリスト

- [ ] オフライン版でセンサー動作確認
- [ ] オフライン版でしきい値の基準値決定
- [ ] CSV エクスポートで最大値を記録
- [ ] オンライン版で複数子機をテスト
- [ ] 複数プレイヤーでの動作確認
- [ ] 最終的なしきい値を `child_device.ino` に反映
- [ ] 本番環境で動作確認

---

## 技術仕様（参考）

### MPU-6050 仕様

- **測定範囲:** ±16g （ただし通常は ±8g で十分）
- **出力形式:** 16bit整数 （-32768 ～ 32767）
- **サンプリング:** デフォルト 8kHz

### ESP-NOW 仕様

- **送信間隔:** 50ms （20Hz）
- **遅延:** 5ms未満
- **受信距離:** 100m以上（環境依存）

---

## 参考資料

- [MPU-6050 Datasheet](https://invensense.tdk.com/products/motion-tracking/6-axis/)
- [ESP-NOW Documentation](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/network/esp_now.html)