# システム設計書

## システムアーキテクチャ

```
┌─────────────────────┐
│    PC (Processing)   │
│  - リアルタイム表示  │
│  - ゲーム管理        │
└──────────┬──────────┘
           │ USB Serial
           │ (115200 baud)
    ┌──────▼───────┐
    │ 親機(ESP32)   │
    │ - 司令塔      │
    │ - データ集約  │
    └──────┬────────┘
           │ ESP-NOW
    ┌──────▼──────────────────┐
    │ 子機1-20 (ESP32+MPU-6050)│
    │ - フリフリ検知           │
    │ - データ送信             │
    └───────────────────────────┘
```

## 通信仕様

### ESP-NOW 通信（子機 → 親機）

**データ構造体:**
```cpp
typedef struct {
  int childID;          // 子機ID (0-19)
  int shakeCount;       // フリフリカウント
  float acceleration;   // 加速度値
} ShakeData;
```

**送信周期:** フリフリ検知時のみ（イベント駆動）

### USB Serial 通信（親機 → PC）

**フォーマット:** (未定)

## フリフリ検知アルゴリズム

1. MPU-6050 から 加速度 (AcX, AcY, AcZ) を読み込み
2. 全体の加速度を計算: `totalAccel = sqrt(AcX² + AcY² + AcZ²)`
3. しきい値と比較: `totalAccel > 15000.0` の場合、フリフリと判定
4. 状態遷移: `!isShaking && totalAccel > THRESHOLD` で カウント +1

## 電源管理

**現在（開発環境）:**
- 親機: PC USB から給電（5V → 3.3V）
- 子機: PC USB から給電（5V → 3.3V）

**将来（本番環境）:**
- 子機: LiPo 3.7V バッテリー（3.3V レギュレータ経由）
- ワイヤレス動作

## パフォーマンス要件

| 項目 | 要件 | 実装 |
|------|------|------|
| 遅延 | <100ms | ESP-NOW による直接通信 |
| 子機数 | 20台 | ハードコード |
| フリフリ検知精度 | 99% | MPU-6050 のしきい値調整 |
| 通信距離 | 最大20m | ESP-NOW 仕様 |